# LMR Rules Authority v1.7.5

## Status
This document is the authoritative rules definition for **Last Man Running (LMR)** as of version **1.7.4**.
It supersedes v1.7.3. Engine, UI, tests, and snapshots must conform to this document.

---

## 1. Dice Lifecycle Overview

A player’s Turn consists of resolving all dice available to that player, including any Extra Dice earned.

Dice move through the following lifecycle states:

1. **Rolled Dice** – Dice generated by a roll action.
2. **Pending Dice** – Rolled dice that are awaiting resolution.
3. **Active Die** – A single Pending Die currently designated for resolution.
4. **Resolved Die** – A die that has been spent by a move or forfeited.

At all times, the lifecycle is governed by the invariants in §4.

---

## 2. Active Die

An **Active Die** is a designation applied to exactly one Pending Die at a time.

- At most one Active Die may exist at any time.
- The Active Die is selected from the set of Pending Dice.
- The Active Die may be re-designated back to Pending without being resolved.
- The existence of an Active Die does **not** force a move or forfeiture.

The Active Die represents the die currently under consideration for resolution.

---

## 3. Pending Dice

When dice are rolled, they enter play as **Pending Dice**.

- Pending Dice must be resolved one at a time.
- When multiple Pending Dice exist, the player chooses which Pending Die becomes the Active Die.
- If no choice is specified, a deterministic order is used.

---

## 4. Banked Extra Dice

### 4.1 Definition

**Banked Extra Dice** represent owed dice that must be rolled before the Turn may advance.

### 4.2 Earning Extra Dice

A player earns one Banked Extra Die for each of the following:
- Rolling a qualifying die value (e.g., 1 or 6, per game options).
- Performing a qualifying capture/kill when Kill Roll is enabled.

### 4.3 Cashout Rule (Locked)

If a player has **N Banked Extra Dice**, the next roll consists of **N dice**, producing **N Pending Dice**, and reducing Banked Extra Dice to zero **before** any new extras are earned from that roll.

Extra Dice earned from that roll are added after the cashout.

---

## 5. Turn Advancement Invariants (§4.4)

A Turn may **not** advance to the next player while **any** of the following conditions hold:

- A die is Active.
- Any Pending Dice remain.
- There are Banked Extra Dice to roll.

These conditions are state-based and do not force a move or forfeiture.

---

## 6. Auto-Pass Clarification

If a roll produces Pending Dice with **no legal moves**, those dice are forfeited via auto-pass.

- Auto-pass resolves all such Pending Dice immediately.
- **If Banked Extra Dice remain after auto-pass, the Turn does not advance.**
- If no Pending Dice and no Banked Extra Dice remain, the Turn may advance.

Auto-pass never bypasses the Banked Extra Dice obligation.

---

## 7. Resolution Rules

- Dice must be rolled before they are resolved.
- Dice must be resolved before a Turn may end.
- Each move resolves exactly one Active Die.

---

## 8. Consistency Requirement

All engine logic, UI behavior, tests, and snapshots must align with this document.
Any deviation is a defect.

---

## Change Log

### v1.7.4
- Canonicalized **Active Die** terminology.
- Locked Banked Extra Dice cashout semantics (N dice at once).
- Clarified Turn advancement invariants.
- Clarified Auto-Pass interaction with Banked Extra Dice.

---

# Optional Module — Rematch Rules

**Status:** Optional  
**Scope:** Room / Game Lifecycle  
**Applies after:** Game Over, Abort, or Cancel  
**Authority:** Server-authoritative

## 1. Definition

A **Rematch (Subsequent Game)** is a new game instance created within the same room immediately following a completed game, using the same players, seats, teams, and game options as the prior game, unless explicitly modified as allowed below.

A Rematch is a distinct game and does not share gameplay state with the prior game.

After this definition, the term **Rematch** is used exclusively.

## 2. Eligibility and Endgame State

A Rematch may be initiated only when the current game is in one of the following terminal states:

- Game Over  
- Aborted  
- Cancelled  

Once a game reaches a terminal state:
- all gameplay actions are rejected  
- the game state is frozen for result inspection  

Upon entering a terminal state, the room enters an **Endgame Results** period.

## 3. Initiation, Consent, and Endgame Results Timer

- Any seated player may request a Rematch.
- A Rematch requires **unanimous consent** from all seated players.
- Only one Rematch request may be active at a time.

### Endgame Results Timer
- When the game enters a terminal state, the server starts a countdown timer of **180 seconds**.
- The remaining time is visible to all players and updates **every second**.

### Timer outcomes
- If a Rematch is unanimously approved before the timer expires, the server performs the Rematch transition.
- If the timer expires without unanimous approval, the server:
  - cancels any active Rematch request
  - transitions the room to **PRE_GAME** (new game setup)
  - does not automatically start a new game

### Immediate transition on Rematch failure
If, during the Endgame Results period, **any** of the following occurs:
- any seated player declines Rematch consent, or
- any seated player disconnects, or
- any seated player leaves the room

Then the server immediately:
1. cancels any active Rematch request  
2. cancels the Endgame Results timer  
3. transitions the room to **PRE_GAME** (new game setup)

No players are removed, and no game is automatically started.

## 4. Rematch Boundary (Atomic Transition)

When unanimous Rematch consent is achieved, the server performs a **single atomic transition** that:

1. Determines the starting player for the Rematch
2. Increments the game sequence identifier (`gameSeq`)
3. Resets all gameplay state
4. Transitions the room into the standard **pre-game** state

This transition defines the boundary between the completed game and the Rematch.

## 5. Reset Semantics

On Rematch transition, the following state is **cleared**:

- All peg positions (reset to base)
- Turn state and phase
- All pending or unresolved dice
- All banked dice
- All per-die delegation
- Finish order
- Winner designation
- `gameOver` flag
- All per-turn and per-die transient state

The following state is **preserved**:

- Player identities
- Seat assignments
- Team assignments
- Game options

## 6. Game Options

- Game options persist from the prior game by default.
- Game options may be modified during the pre-game phase of a Rematch.
- Any option change:
  - requires unanimous agreement
  - immediately clears all players’ Ready state
- Once the game starts, options are locked and may not be changed.

## 7. Starting Player Selection

The starting player for a Rematch is derived from the results of the prior game:

- Solo play: the previous game’s winner starts
- Team play: the first finisher on the winning team starts

This determination is made **once**, during the Rematch transition, before prior-game results are cleared.

## 8. Pre-Game Flow

After the Rematch reset, the game enters the same **pre-game state** as a newly created game:

- Players may adjust options
- Players explicitly mark **Ready**
- The game starts when the normal start condition is met

No alternate start or readiness mechanics are introduced for Rematches.

## 9. Stale Input Handling

- Each game instance is identified by a monotonically increasing `gameSeq`.
- All client commands must include the current `gameSeq`.
- Commands referencing an earlier `gameSeq` are rejected with reason `staleGameSeq`.
- Replay logs are scoped per `(roomId, gameSeq)`.

## 10. Non-Goals

This module does **not** define:

- Host or room-owner authority
- Forced starts or overrides
- Player moderation or removal
- Special Rematch-only option presets
